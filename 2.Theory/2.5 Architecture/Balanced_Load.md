### Балансирование нагрузки

#### Распределение трафика

У нас есть 100 запросов и 5 серверов. Как поделить?

**Циклический перебор (Round Robin)**

- Плюсы:
  - _**Простота.**_ Это самый простой и предсказуемый алгоритм. Легко реализовать и отладить.
  - _**Равномерность.**_ В теории, каждый сервер получает одинаковое количество запросов.
- Минусы
  - _**Не учитывает нагрузку.**_ Один запрос может быть легким, а другой — тяжелым. Round Robin не видит разницы.
  - _**Не учитывает состояние.**_ Может отправить новый запрос на уже перегруженный сервер.

**Наименьшее количество соединений (Least Connections)**

- Плюсы:
  - _**Адаптивность.**_ Это умный алгоритм, который реально распределяет нагрузку, а не просто запросы.
  - _**Эффективность.**_ Выжимает максимум из вашего железа, не давая серверам простаивать.
- Минусы:
  - _**Сложнее.**_ Требует от балансировщика поддерживать состояние (таблицу соединений), что потребляет больше памяти и CPU.
  - _**Не идеален для коротких соединений.**_ Если запросы очень короткие, преимущество этого алгоритма снижается.

**Хеширование по IP-адресу (IP Hash)**

- Плюсы:
  - _**Липкость**._ Все запросы от одного пользователя (с одного IP) будут попадать на один сервер.
  - _**Предсказуемость**._ Маршрут для клиента не меняется.
- Минусы:
  - _**Неравномерность**._ Если один клиент генерирует 90% трафика, вся нагрузка ляжет на один сервер.
  - _**Проблемы с NAT**._ Множество пользователей из одной корпоративной сети могут иметь один внешний IP.

#### Потеря сервиса (Доступность)

Балансировщик отправляет трафик на пять серверов. Но один из них перестал отвечать.

**Проверки состояния (Health Checks)**

- Плюсы:
  - **_Автоматическое исключение._** Балансировщик замечает проблему и перестает слать на него трафик.
  - _**Надежность.**_ Система лечит сама себя, пока вы пьете кофе.
- Минусы:
  - _**Задержка реакции.**_ Между моментом отказа сервера и реакцией балансировщика пройдет несколько секунд.
  - _**Поверхностность.**_ Простая проверка порта не говорит о том, что приложение внутри действительно работает.

**Глубокие проверки состояния**

- Плюсы:
  - _**Точность.**_ Проверяется не только доступность сервера, но и его реальная работоспособность (соединение с БД, кэшем).
  - _**Предотвращение ошибок.**_ Позволяет вывести сервер из ротации еще до того, как он начнет возвращать ошибки.
- Минусы:
  - _**Нагрузка.**_ Частые глубокие проверки могут создавать дополнительную нагрузку на приложение.
  - _**Риск ложных срабатываний.**_ Сбой БД может привести к тому, что балансировщик отключит все серверы.

#### Потеря состояния (сессий)

Пользователь логинится. Первый запрос идет на Сервер А. Второй — на Сервер Б, который ничего о сессии не знает.

**Липкие сессии (Sticky Sessions)**

- Плюсы:
  - _**Простота**_. Не требует изменений в коде приложения. Вся магия на уровне балансировщика.
  - _**Работает из коробки**_ для stateful-приложений.
- Минусы:
  - _**Нарушение балансировки.**_ Один сервер может приклеить к себе много активных пользователей.
  - _**Отсутствие отказоустойчивости.**_ Если приклеенный сервер падает, все его сессии теряются.

**Централизованное хранилище сессий**

- Плюсы:
  - _**Настоящая балансировка.**_ Любой сервер может обработать любой запрос.
  - _**Отказоустойчивость.**_ Если один сервер падает, другой подхватит сессию из Redis.
- Минусы:
  - _**Дополнительная инфраструктура.**_ Требует развертывания отдельного кластера Redis.
  - _**Дополнительная задержка.**_ Каждый запрос требует сетевого похода в Redis.

**Токены на стороне клиента (JWT)**

- Плюсы:
  - _**Идеально для масштабирования.**_ Полностью stateless-архитектура.
  - _**Подходит для микросервисов.**_ Любой сервис может проверить токен.
- Минусы:
  - _**Сложность отзыва.**_ Отозвать токен до истечения его срока жизни сложно.
  - _**Размер.**_ Токен передается с каждым запросом.

#### SSL/TLS шифрование

Кто должен заниматься шифрованием и расшифровкой трафика?

**SSL Passthrough**

- Плюсы:
  - _**Простота балансировщика.**_ Он не тратит свои ресурсы CPU на криптографию.
  - _**Сквозное шифрование**_ (End-to-End).
- Минусы:
  - _**Балансировщик слепой.**_ Он не видит содержимого запроса, что делает невозможной L7-балансировку.
  - _**Сложность управления сертификатами.**_ Сертификат нужно устанавливать на каждом сервере.

**SSL Termination**

- Плюсы:
  - _**Централизованное управление сертификатами.**_
  - _**Умная балансировка (L7).**_ Балансировщик видит весь HTTP-запрос.
- Минусы:
  - _**Нагрузка на балансировщик.**_ Расшифровка — это ресурсоемкая операция.
  - _**Небезопасная внутренняя сеть.**_ Трафик между балансировщиком и серверами идет в открытом виде.

**SSL Bridging (Re-encryption)**

- Плюсы:
  - _**Лучшее из двух миров.**_ Позволяет использовать L7-логику и шифрование во внутренней сети. 
- Минусы:
  - _**Максимальная нагрузка.**_ Выполняется двойная работа по шифрованию/расшифровке.
  - _**Сложность.**_ Самый сложный в настройке вариант.

#### Глобальное распределение

Ваши пользователи находятся по всему миру. Задержки убивают пользовательский опыт.

**Балансировка на уровне DNS**

- Плюсы:
  - _**Простота.**_ Базовый механизм, встроенный во все DNS-провайдеры.
  - _**Прозрачность для клиента.**_
- Минусы:
  - _**Низкая точность геолокации.**_
  - _**Проблемы с кэшированием DNS.**_ Если дата-центр упадет, клиенты еще долго будут к нему стучаться.

**Глобальная серверная балансировка нагрузки (GSLB)**

- Плюсы:
  - **_Высокая отказоустойчивость._** Обеспечивает автоматическое переключение между регионами.
  - _**Оптимизация производительности.**_ Может направлять трафик в наименее загруженный регион.
- Минусы:
  - _**Стоимость.**_ Это дорогая услуга. 

**Anycast IP**

- Плюсы:
  - _**Максимальная производительность и отказоустойчивость.**_ Переключение происходит на уровне сетевой маршрутизации.
  - _**Защита от DDoS.**_
- Минусы:
  - _**Очень сложно и дорого.**_ Требует контроля над собственной автономной системой (AS).

#### Неравномерная мощность серверов

У вас есть два новых мощных сервера и три старых, слабых. Алгоритм Round Robin будет нагружать их одинаково, что приведет к перегрузке слабых.

**Взвешенный циклический перебор (Weighted Round Robin)**

- Плюсы:
  - _**Простота и предсказуемость.**_ Легко понять, как распределяется трафик. 
  - _**Учитывает мощность.**_ Вы можете прямо сказать: этому мощному серверу давай 10 запросов, а этому старому — только 5.
- Минусы:
  - **_Этот метод слеп к реальной обстановке._** Он будет тупо следовать правилу, даже если мощный сервер захлебывается тяжелым отчетом, а слабые машины курят в сторонке. 

**Взвешенное наименьшее количество соединений (Weighted Least Connections)**

- Плюсы:
  - _**Это самый умный подход.**_ Он смотрит не только на паспортную мощность сервера (вес), но и на то, сколько работы у него прямо сейчас (количество соединений).
  - _**Самая эффективная утилизация ресурсов**_ в кластере с разношерстным железом.
- Минусы:
  - _**Сложность.**_ Самый сложный в реализации и настройке алгоритм.
  - _**Требует L7.**_ Балансировщик должен работать на уровне приложения, чтобы отслеживать соединения.

#### Эффект стада (Thundering Herd)

Упавший сервер вернулся в строй после перезагрузки. Health check прошел. Балансировщик немедленно направляет на него шквал трафика, что снова его убивает, так как его внутренние кэши еще не прогреты.

**Плавный ввод в эксплуатацию (Slow Start / Ramp-up)**

- Плюсы:
  - _**Безопасность.**_ Предотвращает повторные сбои, давая серверу время на прогрев.
  - _**Автоматизация.**_ Не требует ручного вмешательства для возвращения сервера в строй.
- Минусы:
  - _**Сниженная производительность.**_ На время прогрева сервер работает не на полную мощность.
  - _**Требует поддержки**_ со стороны балансировщика.

**Нелинейный Ramp-up**

- Плюсы:
  - _**Более агрессивный прогрев.**_ Нагрузка растет не линейно, а экспоненциально, что позволяет быстрее вывести сервер на полную мощность.
- Минусы:
  - _**Риск.**_ Если сервер не готов, он упадет быстрее. Требует более тщательной настройки. 

#### Медленный, но живой сервер

Сервер не упал, health check проходит. Но из-за утечки памяти или блокировки в коде он отвечает на запросы по 10 секунд вместо 100 мс.

**Балансировка на основе задержки (Latency-based)**

- Плюсы:
  - _**Ориентация на пользователя.**_ Алгоритм оптимизирует то, что важнее всего — время ответа для клиента. 
  - _**Быстрая реакция.**_ Автоматически перестает слать трафик на тормозящие серверы.
- Минусы:
  - _**Сложность измерения.**_ Требует от балансировщика постоянно измерять и усреднять время ответа.
  - _**Может быть обманут**_ быстрыми, но бесполезными ответами (например, ошибками).

**Адаптивная балансировка (например, Nginx Plus)**

- Плюсы:
  - _**Комплексный подход.**_ Учитывает не только задержку, но и количество ошибок и активных соединений. 
  - _**Самообучение.**_ Некоторые продвинутые системы могут адаптировать веса серверов на лету.
- Минусы:
  - _**Черный ящик.**_ Логика принятия решений может быть неочевидна.
  - _**Стоимость.**_ Обычно это функциональность коммерческих версий продуктов.

#### Необходимость в L7-манипуляциях

Нужно добавить заголовок X-Request-ID, переписать URL (/old-path -> /new-path) или заблокировать запросы от старых клиентов без определенного User-Agent.

**Использование L7-балансировщика**

- Плюсы:
  - _**Мощность и гибкость.**_ Позволяет реализовать практически любую логику маршрутизации и модификации запросов.
  - _**Централизация.**_ Вся логика находится в одном месте, а не размазана по серверам приложений.
- Минусы:
  - _**Производительность.**_ Анализ и модификация HTTP-запросов требуют больше ресурсов CPU, чем простая L4-маршрутизация.
  - _**Сложность конфигурации.**_ Правила могут стать очень сложными и запутанными.

**Использование API Gateway**

- Плюсы:
  - _**Специализированный инструмент.**_ API Gateway специально создан для таких задач и часто предоставляет более удобные инструменты для их решения. 
- Минусы:
  - _**Дополнительный слой.**_ Это еще один компонент в архитектуре, который стоит перед балансировщиком.

#### Видимость и отладка

Запрос прошел через балансировщик. Что с ним случилось? Почему он ушел на Сервер А, а не на Сервер Б?

**Подробное логирование и метрики**

- Плюсы:
  - _**Пост-анализ.**_ Позволяет расследовать инциденты и понимать поведение системы.
  - _**Основа для мониторинга.**_ Метрики (количество 5xx ошибок, задержки) являются основой для алертов.
- Минусы:
  - _**Объем данных.**_ Логи могут занимать огромный объем.
  - _**Реактивность.**_ Позволяет узнать о проблеме уже после того, как она произошла.

**Распределенная трассировка**

- Плюсы:
  - _**Полная видимость.**_ Позволяет отследить путь запроса через все компоненты системы. 
  - _**Проактивный анализ.**_ Можно анализировать трейсы, чтобы найти узкие места еще до того, as они станут проблемой.
- Минусы:
  - _**Требует интеграции.**_ Все компоненты (балансировщик, серверы) должны поддерживать проброс трейсировочных заголовков.

#### Сложность тестирования

Как протестировать отказоустойчивость или правила L7-маршрутизации?

**Развертывание легковесного балансировщика для тестов**

- Плюсы:
  - _**Высокая достоверность.**_ Тестируется реальный путь запроса через настроенный балансировщик.
  - _**Обнаруживает проблемы конфигурации.**_ Ошибки в правилах будут найдены на этапе тестирования.
- Минусы:
  - _**Замедление CI/CD.**_ Запуск дополнительных контейнеров увеличивает время выполнения тестов.
  - _**Сложность инфраструктуры.**_ Требует поддержки тестовых конфигураций.

**Контрактное тестирование (Pact)**

- Плюсы:
  - _**Скорость и независимость.**_ Позволяет проверить совместимость асинхронно, не запуская всю систему целиком. 
  - _**Явный контракт.**_ Формализует ожидания между потребителем и поставщиком.
- Минусы:
  - _**Высокий порог вхождения.**_ Требует изучения отдельного инструмента и методологии. 
  - _**Не тестирует поведение.**_ Проверяет только структуру запроса/ответа, но не внутреннюю логику.

#### Каскадные сбои

Один медленный сервис подвешивает все потоки балансировщика, что приводит к деградации всей системы.

**Паттерн Автоматический выключатель (Circuit Breaker)**

- Плюсы:
  - _**Изоляция сбоев.**_ Не позволяет проблемам в одном сервисе обрушить всю систему.
  - _**Быстрый отказ (Fail Fast).**_ Не заставляет клиентов ждать таймаута, а сразу возвращает ошибку.
- Минусы:
  - _**Сложность настройки.**_ Неправильно подобранные пороги могут либо не срабатывать, либо срабатывать слишком часто.
  - _**Временная недоступность.**_ Может временно полностью отключить сервис, который испытывает кратковременные проблемы.

**Агрессивные таймауты и повторные попытки**

- Плюсы:
  - _**Защита ресурсов балансировщика.**_ Освобождает потоки и соединения, не давая им зависнуть.
  - _**Повышение отказоустойчивости.**_ Повторные попытки могут скрыть кратковременные сетевые сбои.
- Минусы:
  - _**Риск шторма повторов (Retry Storm).**_ Лавина повторных запросов может окончательно добить сервис, испытывающий проблемы.
  - _**Не подходит для неидемпотентных операций.**_ Повторный POST-запрос может привести к созданию дубликатов.

**Паттерн Переборка (Bulkhead)**

- Плюсы:
  - _**Максимальная изоляция.**_ Проблемы с одним апстримом не затронут запросы к другим.
  - _**Предсказуемость.**_ Позволяет гарантировать ресурсы для критически важных сервисов.
- Минусы:
  - _**Сложность в настройке.**_ Требует тщательного анализа нагрузки для правильного определения размеров пулов.
  - _**Неэффективное использование ресурсов.**_ Ресурсы, выделенные для одного пула, могут простаивать, в то время как другие перегружены.

#### Выбор решений

- _**Простой веб-сайт или стартап.**_ Начните с облачного L7-балансировщика (GCP Load Balancer).
- _**Растущее приложение со сложной логикой.**_ Рассмотрите программные балансировщики (Nginx, HAProxy).
- _**Высоконагруженная, распределенная система.**_ Комбинация: GSLB для регионов, а внутри — кластеры аппаратных (F5) или программных балансировщиков.

**Практические рекомендации**

1. Используйте как минимум два экземпляра всего. Два балансировщика, два сервера.
2. Настройте глубокие health checks. Проверка порта — это самообман.
3. Предпочитайте stateless-архитектуру. Избегайте липких сессий.
4. Терминируйте SSL на балансировщике.
5. Настройте агрессивные, но разумные таймауты.
6. Централизуйте логи и метрики с балансировщика.
7. Автоматизируйте конфигурацию. Храните конфигурацию в Git.
8. Используйте плавный ввод для серверов, возвращающихся в строй.
9. Включите X-Forwarded-For заголовок.
10. Проводите нагрузочное тестирование.
11. Реализуйте Circuit Breaker для защиты от каскадных сбоев.
12. Ваш балансировщик — это тоже сервис. Мониторьте его CPU, память и сетевые соединения.
